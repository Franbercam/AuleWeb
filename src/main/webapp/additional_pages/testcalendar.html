<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/JSP_Servlet/Html.html to edit this template
-->
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../css/calendar.css">
    <iframe src="../additional_pages/navbar.html" width="100%" high="50px"></iframe>
    <link rel="stylesheet" href="../css/bootstrap-5.3.0-dist/css/bootstrap.css">
    <title>Calendario</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='../js/fullcalendar/index.global.min.js'></script>
    <script src='../js/fullcalendar-sheduler/index.global.js'></script>
    <script>
        const id = parseInt(new URL(window.location.href).searchParams.get("id"));
        const idAulaParam = parseInt(new URL(window.location.href).searchParams.get("idAula"));


        window.onload = function () {
            declareListeners();
            loadAulas(loadSelectAulas);
        };


        /*setTimeout(() => {
         calendar.addEvent({
         title: '',
         start: '2023-06-25T16:30:00',
         end: '2023-06-25T18:30:00',
         allDay: false // will make the time show
         }
         );
         
         }, 5000);*/

        function declareListeners() {
            document.querySelector("#select_aulas").addEventListener("change", function () {
                const aulaId = this.options[this.selectedIndex].getAttribute("id");
                loadEventos(aulaId, createCalendario);
            });
            
            document.querySelector("#add_event").addEventListener("click", function(){
                const select = document.querySelector("#select_aulas");
                const aulaId = select.options[select.selectedIndex].getAttribute("id");
                
                if(!aulaId){
                    alert("Seleccione un aula");
                    return;
                }
                
                goToNuevoEvento(aulaId);

                
            });
        }
        function loadAulas(callBack) {
            fetch(`/AuleWeb/AulasServlet?id=${id}`)
                    .then(res => res.json())
                    .then(res => callBack(res));
        }

        function loadEventos(idAula, callBack) {
            fetch(`/AuleWeb/EventosServlet?id=${idAula}`)
                    .then(res => res.json())
                    .then(res => callBack(res));
        }

        function loadSelectAulas(aulas) {
            var select = document.querySelector("#select_aulas");

            aulas.map(aula => {
                var option = document.createElement("option");
                option.setAttribute("id", aula.id);
                option.innerText = aula.nombre;

                select.appendChild(option);
            });
            
            const idAula = !idAulaParam
                ? aulas[0].id
                : idAulaParam;
                
            select.value = document.querySelector("#select_aulas option[id='"+idAula+"']").value; 
            loadEventos(idAula, createCalendario);
        }
       

        function MapToFullCalendarEvent(events) {
                
            return events.map(evento => {
                        
            let color;

            if (evento.tipo === 'conferencia') {
                color = '#FF0909';
            } else if (evento.tipo === 'examen') {
                color = '#FFD209';
            } else if (evento.tipo === 'seminario'){
                color = '#75FF09';
            }  else if (evento.tipo === 'parcial'){
                color ='#09FFD2';
            }else if (evento.tipo === 'mitin'){
                color = '#094CFF';
            }else if (evento.tipo === 'graduacion'){
                color = '#8B09FF';
            }else if (evento.tipo === 'otros'){
                color = '#FF09CF'; 
            } else {
                color = 'black'; // Cambia esto por el color predeterminado si el tipo no coincide con 'x' ni 'Y'
            }
                
                return {
                    title: evento.nombre,
                    start: evento.fechaInicio,
                    end: evento.fechaFin,
                    allDay: false,
                    color: color
                };
            });
        }
        
        function goToNuevoEvento(idAula){
            window.location.href = `addevent.html?idDepartamento=${id}&idAula=${idAula}`;
        }

        function createCalendario(events) {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                initialView: 'timeGridWeek', //dayGridMonth, resourceTimelineFourDays
                slotDuration: '00:05',
                slotMinTime: '08:30:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                events:MapToFullCalendarEvent(events),
                views: {
                    resourceTimelineFourDays: {
                        type: 'resourceTimeline',
                        duration: {days: 1}
                    }
                }
            });

            calendar.render();
        }

    </script>

</head>

<body>
    <div>
        <a href="../index.html" class="btn btn-primary">Home</a>
    </div>
    <div>
        <button id="add_event" class="btn btn-primary">Add Event</button>
    </div>
    <select  class="form-control" id="select_aulas">

    </select>
    <div class="calendar-style" id='calendar'></div>        

    <script src="../css/bootstrap-5.3.0-dist/js/bootstrap.js"></script>
</body>
</html>
